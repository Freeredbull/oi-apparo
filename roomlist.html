<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OI APPARO â€¢ Room List</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<h1>ðŸŽ› Active Music Rooms</h1>
<div id="room-grid" style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));width:100%;max-width:900px;margin:auto;"></div>

<p style="margin-top:2rem;text-align:center;">
  <a href="rooms.html" class="nokia-button">ðŸŽ§ Create / Join Room</a>
</p>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js';

const SUPABASE_URL = 'https://gycoadvqrogvmrdmxntn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5Y29hZHZxcm9ndm1yZG14bnRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMDc2MzcsImV4cCI6MjA2NDc4MzYzN30.hF_0bAwBs1kcCxuSL8UypC2SomDtuCXSVudXSDhwOpI';
const db = createClient(SUPABASE_URL, SUPABASE_KEY);
const grid = document.getElementById('room-grid');

async function loadRooms() {
  const { data: rooms, error } = await db.from('rooms').select('*').eq('public', true).order('created_at', { ascending: false });
  if (error || !rooms) return console.error('Room fetch error:', error);

  const roomsWithUsers = await Promise.all(
    rooms.map(async room => {
      const { count } = await db.from('room_users').select('*', { count: 'exact', head: true }).eq('room_code', room.code);
      return { ...room, userCount: count || 0 };
    })
  );

  roomsWithUsers.sort((a, b) => b.userCount - a.userCount);

  roomsWithUsers.forEach(room => {
    const box = document.createElement('div');
    box.className = 'post';
    box.style.cursor = 'pointer';
    box.onclick = () => window.location = `rooms.html?code=${room.code}`;

    box.innerHTML = `
      <p><strong>${room.name || '(Untitled Room)'}</strong></p>
      <p>ðŸ§¬ Code: ${room.code}</p>
      <p>ðŸ‘¥ Users: ${room.userCount}</p>
    `;
    grid.appendChild(box);
  });
}

loadRooms();
</script>

</body>
</html>
