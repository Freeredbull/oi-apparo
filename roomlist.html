<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Oi Apparo â€¢ Public Music Rooms</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>

<h1>ðŸ“¡ Public Rooms</h1>
<div id="room-grid"></div>

<p style="text-align:center;margin-top:2rem;">
  <a href="room.html" class="nokia-button">âž• Create or Join a Room</a>
</p>

<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js';

  const SUPABASE_URL = "https://gycoadvqrogvmrdmxntn.supabase.co";
  const SUPABASE_KEY = "YOUR_SUPABASE_ANON_KEY_HERE";
  const db = createClient(SUPABASE_URL, SUPABASE_KEY);

  const grid = document.getElementById("room-grid");

  async function cleanupOldRooms() {
    const cutoff = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
    const { data: oldRooms } = await db.from("rooms").select("code").lt("created_at", cutoff);
    for (const room of oldRooms) {
      await db.from("room_users").delete().eq("room_code", room.code);
      await db.from("room_videos").delete().eq("room_code", room.code);
      await db.from("room_chats").delete().eq("room_code", room.code);
      await db.from("rooms").delete().eq("code", room.code);
    }
  }

  async function loadRooms() {
    const { data: rooms } = await db
      .from("rooms")
      .select("code, name, password, created_at")
      .eq("public", true);

    const { data: users } = await db
      .from("room_users")
      .select("room_code, count:room_code")
      .group("room_code");

    const userCounts = {};
    users?.forEach(u => userCounts[u.room_code] = u.count);

    rooms.sort((a, b) => (userCounts[b.code] || 0) - (userCounts[a.code] || 0));

    grid.innerHTML = '';
    rooms.forEach(room => {
      const count = userCounts[room.code] || 0;
      const card = document.createElement("div");
      card.className = "room-card";
      card.innerHTML = `
        <strong>${room.name || "Untitled Room"}</strong><br/>
        <small>Code: ${room.code}</small><br/>
        <small>ðŸ‘¥ ${count} listener(s)</small>
      `;
      card.onclick = () => {
        window.location.href = `room.html?code=${room.code}&pass=${room.password}`;
      };
      grid.appendChild(card);
    });
  }

  await cleanupOldRooms();
  await loadRooms();
</script>

</body>
</html>
