<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OI APPARO â€¢ Room List</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<h1>ðŸŽ› Active Music Rooms</h1>
<div id="room-grid" style="display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));width:100%;max-width:900px;margin:auto;"></div>

<p style="margin-top:2rem;text-align:center;">
  <a href="rooms.html" class="nokia-button">ðŸŽ§ Create / Join Room</a>
</p>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js';

const SUPABASE_URL = 'https://gycoadvqrogvmrdmxntn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5Y29hZHZxcm9ndm1yZG14bnRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMDc2MzcsImV4cCI6MjA2NDc4MzYzN30.hF_0bAwBs1kcCxuSL8UypC2SomDtuCXSVudXSDhwOpI';
const db = createClient(SUPABASE_URL, SUPABASE_KEY);
const grid = document.getElementById('room-grid');

async function loadRooms() {
  const { data: rooms } = await db.from('rooms').select('*').eq('public', true);
  if (!rooms) return;

  const roomCodes = rooms.map(r => r.code);
  const { data: users } = await db
    .from('room_users')
    .select('room_code, count:room_code')
    .in('room_code', roomCodes)
    .group('room_code');

  const userCounts = {};
  users?.forEach(u => userCounts[u.room_code] = u.count || 0);

  rooms.sort((a, b) => (userCounts[b.code] || 0) - (userCounts[a.code] || 0));

  rooms.forEach(room => {
    const box = document.createElement('div');
    box.className = 'post';
    box.style.cursor = 'pointer';
    box.onclick = () => window.location = `rooms.html?code=${room.code}`;

    box.innerHTML = `
      <p><strong>${room.name || '(Untitled Room)'}</strong></p>
      <p>ðŸ§¬ Code: ${room.code}</p>
      <p>ðŸ‘¥ Users: ${userCounts[room.code] || 0}</p>
    `;
    grid.appendChild(box);
  });
}

loadRooms();
</script>

</body>
</html>
